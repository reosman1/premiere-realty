// Prisma Schema for Premiere Realty CRM
// Based on Zoho CRM structure analysis

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// AUTHENTICATION (NextAuth)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(USER)
  accounts      Account[]
  sessions      Session[]
  agentId       String?   @unique
  agent         Agent?    @relation(fields: [agentId], references: [id])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  ADMIN
  MANAGER
  USER
}

// ============================================
// TEAM MEMBERS / AGENTS
// ============================================

model Agent {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // External IDs
  zohoId       String? @unique
  rezenId      String? @unique // REAL Participant ID
  stripeId     String?
  qbVendorId   String? // QuickBooks Vendor Number
  qbVendorName String? // QuickBooks Vendor Name

  // Personal Info
  name          String
  legalName     String?
  email         String  @unique
  personalEmail String?
  workEmail     String?
  phone         String?
  avatarUrl     String?

  // Address
  street  String?
  city    String?
  state   String?
  zipcode String?
  county  String?
  country String?

  // Professional Info
  licenseNumber String?
  licenseExpiry DateTime?
  website       String?

  // Employment
  status           AgentStatus @default(ACTIVE)
  memberLevel      MemberLevel @default(ASSOCIATE)
  hireDate         DateTime?
  departureDate    DateTime?
  firstClosingDate DateTime?
  daysToFirstClose Int?
  career           Career?

  // Commission Structure
  preCapSplitToAgent  Decimal? @default(75.00) @db.Decimal(5, 2) // Pre-cap split %
  postCapSplitToAgent Decimal? @default(95.00) @db.Decimal(5, 2) // Post-cap split %
  perTransactionFee   Decimal? @db.Decimal(12, 2) // Fee after capping

  // Cap Tracking - Team
  teamCapAmount       Decimal?  @default(20000.00) @db.Decimal(12, 2)
  teamCapAmountPaid   Decimal?  @default(0) @db.Decimal(12, 2)
  cappedWithTeam      Boolean   @default(false)
  teamAnniversaryDate DateTime?
  nextTeamAnniversary DateTime?
  lastAnniversaryDate DateTime?

  // Cap Tracking - Brokerage
  brokerageCapAmount       Decimal?  @db.Decimal(12, 2)
  brokerageCapAmountPaid   Decimal?  @default(0) @db.Decimal(12, 2)
  cappedWithBrokerage      Boolean   @default(false)
  brokerageAnniversaryDate DateTime?

  // Roles / Flags
  isActiveSponsor      Boolean @default(false)
  isActiveTeamLeader   Boolean @default(false)
  isActiveDirector     Boolean @default(false)
  isActiveMentor       Boolean @default(false)
  isActiveGrowthLeader Boolean @default(false)
  enrolledInMentorship Boolean @default(false)

  // Mentorship
  mentorAssignmentDate DateTime?
  dealsAsMentee        Int?

  // Stats
  dealsPriorToPG Int? // Deals closed prior to joining
  dealsWithPG    Int? // Deals closed with Premiere
  monthsWithFirm Int?
  daysWithFirm   Int?
  yearsWithFirm  Int?

  // Billing
  paysMonthlyMemberFee Boolean  @default(false)
  monthlyMemberFee     Decimal? @db.Decimal(12, 2)
  balanceDue           Decimal? @default(0) @db.Decimal(12, 2)
  defaultPaymentMethod String?
  subscription         String?

  // Emergency Contact
  emContactName  String?
  emContactPhone String?

  // VA/Assistant
  vaAssistantName  String?
  vaAssistantEmail String?

  // Notes
  notes String? @db.Text

  // Relationships - Hierarchy
  teamLeaderId String?
  teamLeader   Agent?  @relation("TeamLeaderAgents", fields: [teamLeaderId], references: [id])
  teamMembers  Agent[] @relation("TeamLeaderAgents")

  sponsorId       String?
  sponsor         Agent?  @relation("SponsorAgents", fields: [sponsorId], references: [id])
  sponsoredAgents Agent[] @relation("SponsorAgents")

  mentorId String?
  mentor   Agent?  @relation("MentorAgents", fields: [mentorId], references: [id])
  mentees  Agent[] @relation("MentorAgents")

  regionalDirectorId String?
  regionalDirector   Agent?  @relation("DirectorAgents", fields: [regionalDirectorId], references: [id])
  directorAgents     Agent[] @relation("DirectorAgents")

  businessDevDirectorId String?
  businessDevDirector   Agent?  @relation("BizDevAgents", fields: [businessDevDirectorId], references: [id])
  bizDevAgents          Agent[] @relation("BizDevAgents")

  // Related Records
  user               User?
  listings           Listing[]
  transactions       Transaction[]
  commissionPayments CommissionPayment[]
  activityLogs       ActivityLog[]

  @@index([status])
  @@index([email])
  @@index([rezenId])
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  ONBOARDING
  OFFBOARDED
}

enum MemberLevel {
  ASSOCIATE
  PARTNER
  SR_PARTNER
  STAFF
}

enum Career {
  PART_TIME
  FULL_TIME
}

// ============================================
// LISTINGS
// ============================================

model Listing {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // External IDs
  zohoId         String? @unique
  rezenCode      String? // SS Listing Guid
  rezenListingId String? // SS Listing ID
  mlsNumber      String?
  fileId         String?

  // Property Address
  streetNo   String?
  streetName String?
  direction  Direction?
  unitNo     String?
  city       String?
  state      String?
  zipCode    String?
  county     String?

  // Property Details
  listingName  String?
  listingType  ListingType?
  propertyType String?
  yearBuilt    String?

  // Pricing
  listingPrice Decimal? @db.Decimal(12, 2)

  // Commissions
  listingCommissionPct Decimal? @db.Decimal(5, 2)
  listingCommissionAmt Decimal? @db.Decimal(12, 2)
  saleCommissionPct    Decimal? @db.Decimal(5, 2)
  saleCommissionAmt    Decimal? @db.Decimal(12, 2)
  referringAgentName   String?
  referringAmountPct   Decimal? @db.Decimal(5, 2)

  // Dates
  listingDate    DateTime?
  expirationDate DateTime?

  // Status
  stage     ListingStage @default(ACTIVE_LISTING)
  status    String?
  checklist String?

  // Source & Office
  source String?
  office String?

  // Flags
  isPremiereListng Boolean @default(false)
  rezenVerified    Boolean @default(false)
  otcVerified      Boolean @default(false)

  // Title & Escrow
  titleEscrowProvider String?

  // Links
  rezenListingLink      String?
  rezenDealLink         String?
  rezenAssociatedDealId String?

  // Relationships
  agentId String?
  agent   Agent?  @relation(fields: [agentId], references: [id])

  sellerId String?
  seller   Contact? @relation(fields: [sellerId], references: [id])

  transactions Transaction[]
  activityLogs ActivityLog[]

  @@index([stage])
  @@index([agentId])
  @@index([rezenCode])
}

enum Direction {
  N
  S
  E
  W
  NW
  NE
  SE
  SW
}

enum ListingType {
  RESIDENTIAL
  COMMERCIAL
}

enum ListingStage {
  ACTIVE_LISTING
  PENDING
  CLOSED
  EXPIRED
  CANCELED
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // External IDs
  zohoId                String? @unique
  rezenId               String? @unique // REZEN transaction ID (unique identifier)
  brokerTransactionId   String?
  brokerTransactionCode String?
  transactionCode       String? // REZEN transaction code

  // Transaction Info
  name   String
  email  String?
  amount Decimal? @db.Decimal(12, 2) // Sale price

  // Type & Stage
  type           TransactionType?
  stage          TransactionStage @default(NEW_ENTRY)
  status         String?
  statusDetails  String?
  brokerDealType BrokerDealType?
  firmDeal       FirmDealStatus?
  lifecycleState String? // REZEN lifecycle state (e.g., "NEW", "SETTLED", "CALCULATE_LEDGER")

  // Commission
  commissionPct             Decimal? @db.Decimal(5, 3)
  commissionFlatFee         Decimal? @db.Decimal(12, 2)
  grossCommissionGCI        Decimal? @db.Decimal(12, 2)
  grossCommissionAmount     Decimal? @db.Decimal(12, 2) // Gross commission amount from REZEN
  grossCommissionPercentage Decimal? @db.Decimal(5, 2) // Gross commission percentage
  agentSplitPercent         Decimal? @db.Decimal(5, 2) // Agent split percentage
  brokerCompanyCommission   Decimal? @db.Decimal(12, 2) // Broker/Company commission
  firmAdminFee              Decimal? @db.Decimal(12, 2)
  totalPayments             Decimal? @db.Decimal(12, 2)

  // Dates
  contractAcceptanceDate DateTime?
  estimatedClosingDate   DateTime?
  actualClosingDate      DateTime?

  // QuickBooks Integration
  quickbooksId              String? // QB_ID
  quickbooksTransactionName String? // QB_Transaction_Name
  quickbooksInvoiceLink     String? // QB_Invoice_Link

  // CD Payer Info (Title/Escrow)
  cdPayerName           String? // Name of Title Entity Used
  cdPayerBusinessEntity String? // Title and Escrow Provider
  payerName             String?
  payerEmail            String?
  payerPhone            String?
  payerCompany          String?
  payerRole             String?

  // Address (from REZEN)
  addressOneLine      String? // Full address one line
  streetAddress       String?
  city                String?
  state               String?
  zipCode             String?
  county              String?
  country             String?
  unitApartmentNumber String?

  // Flags
  personalDeal           Boolean @default(false)
  firmOwnedLead          Boolean @default(false)
  haltSyncWithBroker     Boolean @default(false)
  haltSyncWithFirmAuto   Boolean @default(false)
  overrideAllAutomations Boolean @default(false)
  disableSplitAutomation Boolean @default(false) // Disable Split Automation

  // Source
  leadSource            String?
  transactionSupportRep String?
  office                String?

  // Links
  brokerListingLink     String?
  brokerTransactionLink String?

  // Relationships
  agentId String?
  agent   Agent?  @relation(fields: [agentId], references: [id])

  listingId String?
  listing   Listing? @relation(fields: [listingId], references: [id])

  primaryContactId String?
  primaryContact   Contact? @relation(fields: [primaryContactId], references: [id])

  participants       TransactionParticipant[]
  commissionPayments CommissionPayment[]
  activityLogs       ActivityLog[]

  @@index([stage])
  @@index([agentId])
  @@index([actualClosingDate])
  @@index([rezenId])
  @@index([lifecycleState])
}

enum TransactionType {
  LISTING
  PURCHASE
  BOTH_PURCHASE_LISTING
  LEASE_TENANT
  LEASE_LANDLORD
  BOTH_LEASE
  REFERRAL
  BPO
  OTHER
}

enum TransactionStage {
  ACTIVE_LISTING
  NEW_ENTRY
  INCOMPLETE
  PENDING
  CLOSED
  CLOSED_ARCHIVED
  EXPIRED
  CANCELED_PEND
  CANCELED_APP
}

enum BrokerDealType {
  SALE
  LEASE
}

enum FirmDealStatus {
  PLEASE_REVIEW
  YES
  NO
}

// ============================================
// TRANSACTION PARTICIPANTS (Commission Splits)
// ============================================

model TransactionParticipant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  agentId String?

  participantName  String
  participantEmail String?
  participantRole  String? // Agent, Sponsor, Team Leader, etc.

  paymentAmount Decimal? @db.Decimal(12, 2)
  paymentPct    Decimal? @db.Decimal(5, 2)

  @@index([transactionId])
}

// ============================================
// COMMISSION PAYMENTS
// ============================================

model CommissionPayment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  zohoId String? @unique

  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  agentId String?
  agent   Agent?  @relation(fields: [agentId], references: [id])

  amount      Decimal?      @db.Decimal(12, 2)
  status      PaymentStatus @default(PENDING)
  paymentType String?

  dateEarned DateTime?
  datePaid   DateTime?

  qbInvoiceId String?
  notes       String? @db.Text

  items CommissionItem[]

  @@index([agentId])
  @@index([status])
}

model CommissionItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  paymentId String
  payment   CommissionPayment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  description String?
  amount      Decimal? @db.Decimal(12, 2)
  itemType    String?

  @@index([paymentId])
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
}

// ============================================
// CONTACTS
// ============================================

model Contact {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  zohoId String? @unique

  firstName String
  lastName  String
  email     String?
  phone     String?

  street  String?
  city    String?
  state   String?
  zipcode String?

  contactType String? // Buyer, Seller, Vendor, etc.
  notes       String? @db.Text

  listings     Listing[]
  transactions Transaction[]

  @@index([email])
}

// ============================================
// FORMULA FIELDS
// ============================================

model FormulaField {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Field Identification
  entityType  String // "Transaction", "Agent", "Listing", "CommissionPayment"
  fieldName   String // Unique field name (e.g., "totalPayments", "grossCommissionGCI")
  displayName String // Human-readable label

  // Formula Definition
  formulaExpression String @db.Text // The formula expression (e.g., "Amount * Commission / 100")
  returnType        String // "currency", "number", "text", "date", "boolean"
  decimalPlaces     Int?   @default(2) // For currency/number types

  // Formula Metadata
  description String? @db.Text
  isActive    Boolean @default(true)

  @@unique([entityType, fieldName])
  @@index([entityType])
  @@index([isActive])
}

// ============================================
// SYNC LOGS (REZEN / Make Integration)
// ============================================

model SyncLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  source       SyncSource
  entityType   String // agent, listing, transaction
  entityId     String?
  externalId   String?
  action       SyncAction
  payload      Json?
  status       SyncStatus @default(PENDING)
  errorMessage String?    @db.Text

  @@index([source, entityType])
  @@index([status])
  @@index([createdAt])
}

enum SyncSource {
  REZEN
  ZOHO
  MAKE
  QUICKBOOKS
}

enum SyncAction {
  CREATE
  UPDATE
  DELETE
}

enum SyncStatus {
  PENDING
  SUCCESS
  FAILED
}

// ============================================
// ACTIVITY LOG / AUDIT TRAIL
// ============================================

model ActivityLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId     String?
  entityType String // agent, listing, transaction
  entityId   String
  action     String // created, updated, deleted, status_changed, etc.
  details    Json?
  ipAddress  String?

  agentId       String?
  agent         Agent?       @relation(fields: [agentId], references: [id])
  listingId     String?
  listing       Listing?     @relation(fields: [listingId], references: [id])
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
}

// ============================================
// ONBOARDING TASKS
// ============================================

model OnboardingTask {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agentId String

  taskName    String
  description String?
  dueDate     DateTime?
  completedAt DateTime?
  completedBy String?
  sortOrder   Int       @default(0)

  @@index([agentId])
}
